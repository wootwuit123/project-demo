<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° - ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <?!= include('style'); ?>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js" crossorigin="anonymous"></script>
  <style>
    /* Global styles and overrides for body and general layout */
    body {
      background: linear-gradient(to bottom right, #f0f2f5, #e0e6ed); /* Lighter grey gradient */
      color: #343a40;
      display: block;
      padding-top: 0;
      min-height: 100vh;
      font-family: 'Inter', sans-serif;
    }

    /* Top Navigation Bar */
    .topnav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #343a40; /* Dark background for nav */
      padding: 0 1.5rem;
      height: 60px;
      color: #fff;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .topnav .title {
      font-size: 1.2rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .topnav .menu {
      display: flex;
      gap: 1.5rem;
    }
    .topnav .menu a {
      color: #adb5bd; /* Lighter grey for links */
      text-decoration: none;
      font-size: 1rem;
      padding: 0.5rem 0.8rem;
      border-radius: 8px;
      transition: background-color 0.3s ease, transform 0.2s ease, color 0.3s ease;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .topnav .menu a.active,
    .topnav .menu a:hover {
      background-color: rgba(255,255,255,0.15);
      transform: translateY(-2px);
      color: #fff;
    }

    /* Main Content Container */
    .container {
      max-width: 1200px; /* Wider container for data tables */
      margin: 2.5rem auto;
      padding: 2.5rem;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.15);
      animation: fadeIn 0.8s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h1 {
      text-align: center;
      margin-bottom: 0.8rem;
      font-weight: 700;
      font-size: 2.5rem;
      color: #007bff;
    }

    .subtitle {
      margin: 0 0 2.5rem;
      color: #6c757d;
      font-size: 1.15rem;
      line-height: 1.5;
      text-align: center;
      border-bottom: 1px solid #dee2e6;
      padding-bottom: 1.5rem;
    }

    /* Filter and Search Bar */
    .filter-section {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 2rem;
        align-items: center;
        justify-content: center;
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 12px;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
    .filter-section input[type="text"],
    .filter-section select {
        padding: 0.8rem 1rem;
        border: 1px solid #ced4da;
        border-radius: 8px;
        font-size: 1rem;
        flex-grow: 1; /* Allows inputs to grow */
        max-width: 300px; /* Max width for individual inputs */
    }
    .filter-section button {
        padding: 0.8rem 1.5rem;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.2s ease;
    }
    .filter-section button:hover {
        background-color: #0056b3;
        transform: translateY(-2px);
    }

    /* Repair Table Styling */
    .repair-table-container {
      overflow-x: auto; /* Enable horizontal scrolling on small screens */
      margin-top: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      background-color: #fdfdfd;
    }

    .repair-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px; /* Ensure table doesn't get too small */
    }

    .repair-table th,
    .repair-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #e9ecef;
    }

    .repair-table th {
      background-color: #007bff; /* Primary blue for table header */
      color: white;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.9rem;
      position: sticky; /* Keep header sticky on scroll */
      top: 0;
    }

    .repair-table tbody tr:hover {
      background-color: #e2f2ff; /* Light blue on row hover */
      cursor: pointer;
    }
    .repair-table tbody tr:nth-child(even) {
        background-color: #f8f9fa; /* Zebra striping */
    }

    /* Status Badges */
    .status-badge {
      display: inline-block;
      padding: 0.4em 0.8em;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 600;
      text-align: center;
      white-space: nowrap;
      color: white;
    }
    .status-badge.reported { background-color: #ffc107; color: #343a40; } /* Yellow */
    .status-badge.in-progress { background-color: #17a2b8; } /* Cyan */
    .status-badge.completed { background-color: #28a745; } /* Green */
    .status-badge.cancelled { background-color: #6c757d; } /* Grey */

    /* Action Buttons in table */
    .action-buttons button {
      background-color: #6c757d; /* Default grey for action */
      color: white;
      border: none;
      padding: 0.5em 0.8em;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.85em;
      margin-right: 5px;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    .action-buttons button:hover {
        transform: translateY(-1px);
    }
    .action-buttons button.view { background-color: #007bff; } /* Blue for view */
    .action-buttons button.view:hover { background-color: #0056b3; }
    .action-buttons button.edit { background-color: #ffc107; color: #343a40; } /* Yellow for edit */
    .action-buttons button.edit:hover { background-color: #e0a800; }
    .action-buttons button.delete { background-color: #dc3545; } /* Red for delete */
    .action-buttons button.delete:hover { background-color: #c82333; }
    .action-buttons button.complete { background-color: #28a745; } /* Green for complete */
    .action-buttons button.complete:hover { background-color: #218838; }

    /* Custom Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: #fff;
      padding: 2.5rem 3rem;
      border-radius: 16px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.25);
      text-align: center;
      max-width: 600px; /* Wider modal for details */
      animation: zoomIn 0.3s ease-out;
      overflow-y: auto; /* Enable scrolling for modal content */
      max-height: 90vh; /* Max height of modal */
    }
    .modal-content h3 {
      font-size: 1.8rem;
      margin-bottom: 1rem;
      color: #0056b3;
    }
    .modal-content p {
      font-size: 1.1rem;
      color: #555;
      margin-bottom: 1.5rem;
      line-height: 1.6;
      text-align: left;
    }
    .modal-content .detail-item {
        margin-bottom: 0.8rem;
    }
    .modal-content .detail-item strong {
        display: inline-block;
        width: 150px; /* Align labels */
        color: #343a40;
    }
    .modal-content .detail-item img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        margin-top: 1rem;
        border: 1px solid #eee;
    }
    .modal-close-button {
      background: #007bff;
      color: white;
      border: none;
      padding: 0.8rem 2rem;
      border-radius: 8px;
      font-size: 1.05rem;
      cursor: pointer;
      transition: background 0.2s ease;
      margin-top: 1.5rem;
    }
    .modal-close-button:hover {
      background: #0056b3;
    }
    @keyframes zoomIn {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    
    /* Responsive Adjustments for Modal */
    @media (max-width: 768px) {
      .modal-content {
        padding: 1.5rem;
        max-width: 95%;
      }
      .modal-content h3 {
        font-size: 1.5rem;
      }
      .modal-content p {
        font-size: 1rem;
      }
      .modal-content .detail-item strong {
          width: 100px; /* Adjust label width for smaller screens */
          display: block; /* Stack label and value */
          margin-bottom: 0.2rem;
      }
      .modal-close-button {
        padding: 0.7rem 1.5rem;
        font-size: 1rem;
      }
    }

    /* Custom Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .loading-content {
      background: #fff;
      padding: 2.5rem 3rem;
      border-radius: 16px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.25);
      text-align: center;
      max-width: 450px;
      animation: zoomIn 0.3s ease-out;
    }
    .loading-spinner {
        border: 4px solid rgba(0, 123, 255, 0.3); /* Blue spinner */
        border-top: 4px solid #007bff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px auto;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .loading-message {
        font-size: 1.1rem;
        color: #555;
    }

    /* Styles for the edit modal's form groups */
    #edit-modal .form-group label {
        display: block;
        margin-bottom: 0.6rem;
        font-weight: 600;
        color: #444;
        font-size: 1rem;
    }
    #edit-modal .form-group input[type="text"],
    #edit-modal .form-group input[type="tel"],
    #edit-modal .form-group textarea,
    #edit-modal .form-group select {
        width: 100%;
        padding: 0.8rem 1rem;
        border: 1px solid #cceeff;
        border-radius: 8px;
        font-size: 0.95rem;
        box-sizing: border-box;
        background-color: #f8fcfd;
        transition: border-color 0.3s, box-shadow 0.3s;
        margin-bottom: 0.8rem; /* Space between fields */
    }
    #edit-modal .form-group input:focus,
    #edit-modal .form-group textarea:focus,
    #edit-modal .form-group select:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
    }
    #edit-modal .form-group textarea {
      min-height: 80px; /* Smaller textarea for modal */
      resize: vertical;
    }
    #edit-modal .radio-group {
        display: flex;
        flex-wrap: wrap;
        gap: 0.8rem;
        margin-top: 0.5rem;
        justify-content: flex-start; /* Align radios to start */
    }
    #edit-modal .radio-group label {
        padding: 0.6rem 1rem;
        font-size: 0.9rem;
    }
  </style>
</head>
<body>

  <!-- Top Navigation Bar -->
  <nav class="topnav">
    <div class="title"><i class="fas fa-bolt"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞</div>
    <div class="menu">
      <a onclick="loadDashboard()"><i class="fas fa-home"></i> ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
      <a onclick="loadReportRepair()"><i class="fas fa-plus-circle"></i> ‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÉ‡∏´‡∏°‡πà</a>
      <a class="active" onclick="loadStatus()"><i class="fas fa-tools"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</a>
      <a onclick="logout()"><i class="fas fa-sign-out-alt"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
    </div>
  </nav>

  <!-- Main Content Container -->
  <div class="container">
    <h1>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</h1>
    <p class="subtitle">
      ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    </p>

    <!-- Filter and Search Section -->
    <div class="filter-section">
      <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏£‡∏´‡∏±‡∏™, ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á, ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà...">
      <select id="statusFilter">
        <option value="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        <option value="‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß">‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß</option>
        <option value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
        <option value="‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</option>
        <option value="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
      </select>
      <button onclick="applyFilter()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡∏Å‡∏£‡∏≠‡∏á</button>
      <button onclick="clearFilters()">‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
    </div>

    <!-- Repair Table Container -->
    <div class="repair-table-container">
      <table class="repair-table">
        <thead>
          <tr>
            <th>‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</th>
            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            <th>‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á</th>
            <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
            <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th>
            <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤</th>
            <th>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</th>
            <th>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
          </tr>
        </thead>
        <tbody id="repairTableBody">
          <!-- Data rows will be inserted here by JavaScript -->
        </tbody>
      </table>
      <div id="noDataMessage" style="display: none;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay" style="display: none;">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <p id="loading-message">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>
  </div>

  <!-- Custom Modal for messages and repair details -->
  <div id="custom-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <h3 id="modal-title">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3>
      <p id="modal-message"></p>
      <div id="modal-details-content" style="display: none;">
        <!-- Detailed repair info will be loaded here -->
        <div class="detail-item"><strong>‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°:</strong> <span id="detail-repairId"></span></div>
        <div class="detail-item"><strong>‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤:</strong> <span id="detail-timestamp"></span></div>
        <div class="detail-item"><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> <span id="detail-status"></span></div>
        <div class="detail-item"><strong>‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á:</strong> <span id="detail-reporterName"></span></div>
        <div class="detail-item"><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</strong> <span id="detail-phoneNumber"></span></div>
        <div class="detail-item"><strong>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô:</strong> <span id="detail-department"></span></div>
        <div class="detail-item"><strong>‡πÄ‡∏•‡∏Ç ‡∏õ‡∏ä‡∏ä.:</strong> <span id="detail-citizenID"></span></div>
        <div class="detail-item"><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</strong> <span id="detail-location"></span></div>
        <div class="detail-item"><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</strong> <span id="detail-repairType"></span></div>
        <div class="detail-item"><strong>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</strong> <span id="detail-repairDesc"></span></div>
        <div class="detail-item"><strong>‡∏û‡∏¥‡∏Å‡∏±‡∏î:</strong> <span id="detail-geoCode"></span></div>
        <div class="detail-item"><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏≤‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î:</strong> <span id="detail-geoAddress"></span></div>
        <div class="detail-item"><strong>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö:</strong> <span id="detail-assignee"></span></div>
        <div class="detail-item" id="detail-photo-container" style="display: none;">
          <strong>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û:</strong><br>
          <img id="detail-photo" src="" alt="‡∏†‡∏≤‡∏û‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°">
        </div>
      </div>
      <div class="button-group-modal" style="margin-top: 1.5rem;">
        <button class="modal-close-button" onclick="hideModal()">‡∏ï‡∏Å‡∏•‡∏á</button>
        <!-- Action buttons for details modal (e.g., Edit, Complete, Delete) -->
        <button class="primary" id="modalEditBtn" style="display:none;" onclick="openEditModalFromDetail()"><i class="fas fa-edit"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        <button class="secondary" id="modalCompleteBtn" style="display:none; background-color: #28a745;" onclick="completeRepair()"><i class="fas fa-check"></i> ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>
        <button class="secondary" id="modalCancelBtn" style="display:none; background-color: #dc3545;" onclick="cancelRepair()"><i class="fas fa-times"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</button>
      </div>
    </div>
  </div>

  <!-- Edit Repair Modal (Expanded to include more fields) -->
  <div id="edit-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <h3>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</h3>
      <form id="edit-repair-form">
        <input type="hidden" id="edit-repairId-hidden">
        
        <div class="form-group">
            <label for="edit-reporterName">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á:</label>
            <input type="text" id="edit-reporterName" name="reporterName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á">
        </div>
        <div class="form-group">
            <label for="edit-phoneNumber">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:</label>
            <input type="tel" id="edit-phoneNumber" name="phoneNumber" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå">
        </div>
        <div class="form-group">
            <label for="edit-department">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô:</label>
            <input type="text" id="edit-department" name="department" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î">
        </div>
        <div class="form-group">
            <label for="edit-citizenID">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô:</label>
            <input type="text" id="edit-citizenID" name="citizenID" placeholder="13 ‡∏´‡∏•‡∏±‡∏Å" maxlength="13">
        </div>
        <div class="form-group">
            <label for="edit-location">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏:</label>
            <input type="text" id="edit-location" name="location" placeholder="‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏">
        </div>
        <div class="form-group">
            <label for="edit-repairType">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°:</label>
            <div class="radio-group">
                <label>
                    <input type="radio" name="editRepairType" value="‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞">
                    <span><i class="fas fa-lightbulb"></i> ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞</span>
                </label>
                <label>
                    <input type="radio" name="editRepairType" value="‡∏ñ‡∏ô‡∏ô/‡∏ó‡∏≤‡∏á‡πÄ‡∏ó‡πâ‡∏≤">
                    <span><i class="fas fa-road"></i> ‡∏ñ‡∏ô‡∏ô/‡∏ó‡∏≤‡∏á‡πÄ‡∏ó‡πâ‡∏≤</span>
                </label>
                <label>
                    <input type="radio" name="editRepairType" value="‡∏ô‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏õ‡∏≤">
                    <span><i class="fas fa-faucet"></i> ‡∏ô‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏õ‡∏≤</span>
                </label>
                <label>
                    <input type="radio" name="editRepairType" value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">
                    <span><i class="fas fa-ellipsis-h"></i> ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</span>
                </label>
            </div>
        </div>
        <div class="form-group">
            <label for="edit-repairDesc">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤:</label>
            <textarea id="edit-repairDesc" name="repairDesc" placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏õ‡∏±‡∏ç‡∏´‡∏≤" rows="4"></textarea>
        </div>
        <div class="form-group">
            <label for="edit-geoStamp">‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≤‡∏á‡∏†‡∏π‡∏°‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå:</label>
            <input type="text" id="edit-geoStamp" name="geoStamp" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2024-06-27 10:30:00">
        </div>
        <div class="form-group">
            <label for="edit-geoCode">‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏≤‡∏á‡∏†‡∏π‡∏°‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå (‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î, ‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î):</label>
            <input type="text" id="edit-geoCode" name="geoCode" placeholder="‡πÄ‡∏ä‡πà‡∏ô 13.7563, 100.5018">
        </div>
        <div class="form-group">
            <label for="edit-geoAddress">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏≤‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î:</label>
            <input type="text" id="edit-geoAddress" name="geoAddress" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°">
        </div>

        <div class="form-group">
            <label for="edit-status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</label>
            <select id="edit-status" name="status">
                <option value="‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß">‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß</option>
                <option value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                <option value="‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</option>
                <option value="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
            </select>
        </div>
        <div class="form-group">
            <label for="edit-assignee">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö:</label>
            <input type="text" id="edit-assignee" name="assignee" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö">
        </div>
        <div class="button-group-modal">
            <button type="button" class="primary" onclick="saveEditedRepair()"><i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button type="button" class="secondary" onclick="hideEditModal()"><i class="fas fa-times-circle"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
      </form>
    </div>
  </div>


  <script>
    let allRepairData = []; // Store all data fetched from Apps Script
    let currentFilterStatus = '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'; // Current filter from URL or dropdown
    let currentSearchTerm = ''; // Current search term
    let currentDetailRepairId = null; // Store the ID of the repair being viewed in detail modal

    /**
     * Logs debug messages to the console.
     * @param {string} message The message to log.
     */
    function debugLog(message) {
      console.log('üîß STATUS DEBUG:', message);
    }

    /**
     * Displays a custom modal dialog with a given message and title.
     * @param {string} message The message to display.
     * @param {string} [title='‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô'] The title of the modal.
     * @param {boolean} [isDetail=false] Whether the modal is showing repair details.
     * @returns {Promise<void>} A promise that resolves when the modal is closed.
     */
    function showModal(message, title = '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', isDetail = false) {
      return new Promise(resolve => {
        const modal = document.getElementById('custom-modal');
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-message').innerHTML = message;

        if (isDetail) {
          document.getElementById('modal-message').style.display = 'none'; // Hide generic message for details
          document.getElementById('modal-details-content').style.display = 'block'; // Show detail content
          document.getElementById('modalEditBtn').style.display = 'inline-block';
          document.getElementById('modalCompleteBtn').style.display = 'inline-block';
          document.getElementById('modalCancelBtn').style.display = 'inline-block';
        } else {
          document.getElementById('modal-message').style.display = 'block'; // Show generic message
          document.getElementById('modal-details-content').style.display = 'none'; // Hide detail content
          document.getElementById('modalEditBtn').style.display = 'none';
          document.getElementById('modalCompleteBtn').style.display = 'none';
          document.getElementById('modalCancelBtn').style.display = 'none';
        }
        
        modal.style.display = 'flex';
        // When closing the modal, hide the action buttons as well
        document.querySelector('.modal-close-button').onclick = () => {
          hideModal();
          resolve();
        };
      });
    }

    /**
     * Hides the custom modal dialog.
     */
    function hideModal() {
      document.getElementById('custom-modal').style.display = 'none';
      document.getElementById('modal-details-content').style.display = 'none'; // Ensure hidden on close
      document.getElementById('modalEditBtn').style.display = 'none'; // Hide action buttons
      document.getElementById('modalCompleteBtn').style.display = 'none';
      document.getElementById('modalCancelBtn').style.display = 'none';
      currentDetailRepairId = null; // Clear the current detail ID
    }

    /**
     * Shows the loading overlay.
     * @param {string} [message='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...'] The message to display.
     */
    function showLoading(message = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...') {
      document.getElementById('loading-message').textContent = message;
      document.getElementById('loading-overlay').style.display = 'flex';
    }

    /**
     * Hides the loading overlay.
     */
    function hideLoading() {
      document.getElementById('loading-overlay').style.display = 'none';
    }

    // --- Navigation Functions (re-used from other pages) ---
    function loadDashboard() {
      debugLog('loadDashboard called');
      try {
        if (typeof google === 'undefined' || !google.script || !google.script.run) throw new Error('Google Apps Script not ready.');
        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å...');
        google.script.run.withSuccessHandler(html => { hideLoading(); document.open(); document.write(html); document.close(); }).withFailureHandler(e => { hideLoading(); showModal('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message); }).getDashboardPage();
      } catch (error) { hideLoading(); showModal('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message); }
    }

    function loadReportRepair() {
      debugLog('loadReportRepair called');
      try {
        if (typeof google === 'undefined' || !google.script || !google.script.run) throw new Error('Google Apps Script not ready.');
        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°...');
        google.script.run.withSuccessHandler(html => { hideLoading(); document.open(); document.write(html); document.close(); }).withFailureHandler(e => { hideLoading(); showModal('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message); }).getReportRepairPage();
      } catch (error) { hideLoading(); showModal('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message); }
    }

    function loadStatus() {
      debugLog('loadStatus called');
      try {
        if (typeof google === 'undefined' || !google.script || !google.script.run) throw new Error('Google Apps Script not ready.');
        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°...');
        google.script.run.withSuccessHandler(html => { hideLoading(); document.open(); document.write(html); document.close(); }).withFailureHandler(e => { hideLoading(); showModal('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message); }).getStatusPage();
      } catch (error) { hideLoading(); showModal('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message); }
    }

    function logout() {
      debugLog('logout called');
      showModal('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö').then(() => {
        try {
          if (typeof google === 'undefined' || !google.script || !google.script.run) throw new Error('Google Apps Script not ready.');
          showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö...');
          google.script.run.withSuccessHandler(html => { hideLoading(); document.open(); document.write(html); document.close(); }).withFailureHandler(e => { hideLoading(); showModal('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö: ' + e.message); }).doLogout();
        } catch (error) { hideLoading(); showModal('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message); }
      });
    }

    // --- Repair Data Management ---

    /**
     * Fetches repair data from Apps Script, filters it, and displays it in the table.
     */
    async function fetchRepairData() {
      debugLog('fetchRepairData called');
      showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°...');
      try {
        if (typeof google === 'undefined' || !google.script || !google.script.run) {
          throw new Error('Google Apps Script environment is not ready.');
        }

        const data = await google.script.run.withSuccessHandler(res => {
          allRepairData = res; // Store all fetched data
          applyFilter(); // Apply current filters after data is loaded
          hideLoading();
          debugLog('Repair data fetched successfully. Total items: ' + allRepairData.length);
        }).withFailureHandler(e => {
          hideLoading();
          showModal('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÑ‡∏î‡πâ: ' + e.message, '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
          debugLog('Failed to fetch repair data: ' + e.message);
          renderTable([]); // Render empty table on failure
        }).getRepairData(); // Calls getRepairData from Code.gs
      } catch (error) {
        hideLoading();
        showModal('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
        debugLog('Error in fetchRepairData: ' + error.message);
      }
    }

    /**
     * Filters the repair data based on search term and status, then renders the table.
     */
    function applyFilter() {
      debugLog('applyFilter called');
      currentSearchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
      currentFilterStatus = document.getElementById('statusFilter').value;

      const filteredData = allRepairData.filter(item => {
        const matchesSearch = currentSearchTerm === '' ||
                              String(item['‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°']).toLowerCase().includes(currentSearchTerm) ||
                              String(item['‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á']).toLowerCase().includes(currentSearchTerm) ||
                              String(item['‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏']).toLowerCase().includes(currentSearchTerm) ||
                              String(item['‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤']).toLowerCase().includes(currentSearchTerm);
        
        const matchesStatus = currentFilterStatus === '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' ||
                              String(item['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞']).trim() === currentFilterStatus;
        
        return matchesSearch && matchesStatus;
      });

      renderTable(filteredData);
      debugLog(`Filter applied: Search "${currentSearchTerm}", Status "${currentFilterStatus}". Displaying ${filteredData.length} items.`);
    }

    /**
     * Clears the search and status filters and re-renders the table.
     */
    function clearFilters() {
      document.getElementById('searchInput').value = '';
      document.getElementById('statusFilter').value = '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
      applyFilter();
      debugLog('Filters cleared.');
    }

    /**
     * Renders the provided repair data into the HTML table.
     * @param {Array<Object>} dataToRender The array of repair data objects to display.
     */
    function renderTable(dataToRender) {
      const tableBody = document.getElementById('repairTableBody');
      tableBody.innerHTML = ''; // Clear existing rows
      const noDataMessage = document.getElementById('noDataMessage');

      if (dataToRender.length === 0) {
        noDataMessage.style.display = 'block';
        return;
      } else {
        noDataMessage.style.display = 'none';
      }

      dataToRender.forEach(item => {
        const row = tableBody.insertRow();
        row.dataset.repairId = item['‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°']; // Store ID for actions

        // Determine status badge class
        let statusClass = '';
        switch (item['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞']) {
          case '‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß': statusClass = 'reported'; break;
          case '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£': statusClass = 'in-progress'; break;
          case '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢': statusClass = 'completed'; break;
          case '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å': statusClass = 'cancelled'; break;
          default: statusClass = ''; break;
        }

        // --- FIX: Ensure '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤' is a string before calling substring ---
        const truncatedDescription = String(item['‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤'] || '').substring(0, 50) + '...';

        row.innerHTML = `
          <td>${item['‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°'] || ''}</td>
          <td><span class="status-badge ${statusClass}">${item['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'] || ''}</span></td>
          <td>${item['‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á'] || ''}</td>
          <td>${item['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå'] || ''}</td>
          <td>${item['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°'] || ''}</td>
          <td>${item['‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏'] || ''}</td>
          <td>${truncatedDescription}</td>
          <td>${item['‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö'] || '-'}</td>
          <td class="action-buttons">
            <button class="view" onclick="viewRepairDetails('${item['‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°']}')"><i class="fas fa-eye"></i> ‡∏î‡∏π</button>
            <button class="edit" onclick="openEditModal('${item['‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°']}')"><i class="fas fa-edit"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button class="delete" onclick="confirmDelete('${item['‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°']}')"><i class="fas fa-trash-alt"></i> ‡∏•‡∏ö</button>
          </td>
        `;
      });
      debugLog(`Table rendered with ${dataToRender.length} items.`);
    }

    /**
     * Opens a modal to display detailed information of a repair request.
     * @param {string} repairId The ID of the repair request to view.
     */
    async function viewRepairDetails(repairId) {
      debugLog('viewRepairDetails called for ID: ' + repairId);
      currentDetailRepairId = repairId; // Store the ID for modal action buttons
      showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î...');
      try {
        if (typeof google === 'undefined' || !google.script || !google.script.run) {
          throw new Error('Google Apps Script environment is not ready.');
        }

        const detail = await google.script.run.withSuccessHandler(res => {
          hideLoading();
          if (res) {
            document.getElementById('detail-repairId').textContent = res['‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°'] || '-';
            document.getElementById('detail-timestamp').textContent = res['‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤'] || '-';
            document.getElementById('detail-status').textContent = res['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'] || '-';
            document.getElementById('detail-reporterName').textContent = res['‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á'] || '-';
            document.getElementById('detail-phoneNumber').textContent = res['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå'] || '-';
            document.getElementById('detail-department').textContent = res['‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô'] || '-';
            document.getElementById('detail-citizenID').textContent = res['‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô'] || '-';
            document.getElementById('detail-location').textContent = res['‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏'] || '-';
            document.getElementById('detail-repairType').textContent = res['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°'] || '-';
            document.getElementById('detail-repairDesc').textContent = res['‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤'] || '-';
            document.getElementById('detail-geoCode').textContent = res['GeoCode'] || '-';
            document.getElementById('detail-geoAddress').textContent = res['GeoAddress'] || '-';
            document.getElementById('detail-assignee').textContent = res['‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö'] || '-';

            const photoContainer = document.getElementById('detail-photo-container');
            const photoImg = document.getElementById('detail-photo');
            if (res['PhotoUrl']) {
              photoImg.src = res['PhotoUrl'];
              photoContainer.style.display = 'block';
            } else {
              photoImg.src = '';
              photoContainer.style.display = 'none';
            }
            
            // Set repairId for modal action buttons (using currentDetailRepairId)
            // Buttons will use currentDetailRepairId directly now

            // Adjust visibility of complete/cancel buttons based on status
            const currentStatus = res['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'];
            if (currentStatus === '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' || currentStatus === '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å') {
              document.getElementById('modalCompleteBtn').style.display = 'none';
              document.getElementById('modalCancelBtn').style.display = 'none';
            } else {
              document.getElementById('modalCompleteBtn').style.display = 'inline-block';
              document.getElementById('modalCancelBtn').style.display = 'inline-block';
            }

            showModal('', '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°', true); // Show detail modal
            debugLog('Repair details loaded and displayed for ID: ' + repairId);

          } else {
            showModal('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏ô‡∏µ‡πâ', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
          }
        }).withFailureHandler(e => {
          hideLoading();
          showModal('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÑ‡∏î‡πâ: ' + e.message, '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
          debugLog('Failed to fetch repair details: ' + e.message);
        }).getRepairDetails(repairId); // Calls getRepairDetails from Code.gs
      } catch (error) {
        hideLoading();
        showModal('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
        debugLog('Error in viewRepairDetails: ' + error.message);
      }
    }

    /**
     * Opens the edit modal from the table row.
     * @param {string} repairId The ID of the repair to edit.
     */
    async function openEditModal(repairId) {
        debugLog('openEditModal called for ID: ' + repairId);
        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç...');
        try {
            const detail = await google.script.run.withSuccessHandler(res => {
                hideLoading();
                if (res) {
                    document.getElementById('edit-repairId-hidden').value = repairId;
                    // Populate all editable fields
                    document.getElementById('edit-reporterName').value = res['‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á'] || '';
                    document.getElementById('edit-phoneNumber').value = res['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå'] || '';
                    document.getElementById('edit-department').value = res['‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô'] || '';
                    document.getElementById('edit-citizenID').value = res['‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô'] || '';
                    document.getElementById('edit-location').value = res['‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏'] || '';
                    document.getElementById('edit-repairDesc').value = res['‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤'] || '';
                    document.getElementById('edit-geoStamp').value = res['GeoStamp'] || '';
                    document.getElementById('edit-geoCode').value = res['GeoCode'] || '';
                    document.getElementById('edit-geoAddress').value = res['GeoAddress'] || '';
                    
                    // Set radio button for repair type
                    const repairTypeRadios = document.querySelectorAll('input[name="editRepairType"]');
                    repairTypeRadios.forEach(radio => {
                        if (radio.value === res['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°']) {
                            radio.checked = true;
                        } else {
                            radio.checked = false; // Ensure others are unchecked
                        }
                    });

                    document.getElementById('edit-status').value = res['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'] || '‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß';
                    document.getElementById('edit-assignee').value = res['‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö'] || '';
                    
                    document.getElementById('edit-modal').style.display = 'flex';
                    debugLog('Edit modal opened for ID: ' + repairId);
                } else {
                    showModal('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
                }
            }).withFailureHandler(e => {
                hideLoading();
                showModal('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ: ' + e.message, '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
            }).getRepairDetails(repairId);
        } catch (error) {
            hideLoading();
            showModal('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
        }
    }
    
    /**
     * Opens the edit modal directly from the detail view modal.
     * It uses the `currentDetailRepairId` global variable.
     */
    function openEditModalFromDetail() {
        if (currentDetailRepairId) {
            hideModal(); // Hide the detail modal first
            openEditModal(currentDetailRepairId); // Open edit modal using the stored ID
        } else {
            showModal('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
        }
    }


    /**
     * Hides the edit modal.
     */
    function hideEditModal() {
      document.getElementById('edit-modal').style.display = 'none';
      debugLog('Edit modal closed.');
    }

    /**
     * Saves the edited repair data.
     */
    async function saveEditedRepair() {
      debugLog('saveEditedRepair called');
      const repairId = document.getElementById('edit-repairId-hidden').value;
      
      // Collect all data from the edit modal
      const updatedData = {
          '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á': document.getElementById('edit-reporterName').value.trim(),
          '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå': document.getElementById('edit-phoneNumber').value.trim(),
          '‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô': document.getElementById('edit-department').value.trim(),
          '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô': document.getElementById('edit-citizenID').value.trim(),
          '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏': document.getElementById('edit-location').value.trim(),
          '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°': document.querySelector('input[name="editRepairType"]:checked')?.value || '', // Get selected radio value
          '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤': document.getElementById('edit-repairDesc').value.trim(),
          'GeoStamp': document.getElementById('edit-geoStamp').value.trim(),
          'GeoCode': document.getElementById('edit-geoCode').value.trim(),
          'GeoAddress': document.getElementById('edit-geoAddress').value.trim(),
          '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞': document.getElementById('edit-status').value,
          '‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö': document.getElementById('edit-assignee').value.trim()
      };

      // Basic validation for required fields in edit modal
      if (!updatedData['‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á'] || !updatedData['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå'] || !updatedData['‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏'] || !updatedData['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°'] || !updatedData['‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤']) {
        showModal('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
        return;
      }
      if (!/^[0-9]{10,12}$/.test(updatedData['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå'].replace(/[-\s]/g, ''))) {
        showModal('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 10-12 ‡∏´‡∏•‡∏±‡∏Å)', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        return;
      }
      if (updatedData['‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô'] && !/^[0-9]{13}$/.test(updatedData['‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô'])) {
        showModal('‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 13 ‡∏´‡∏•‡∏±‡∏Å', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        return;
      }
      
      showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
      try {
        if (typeof google === 'undefined' || !google.script || !google.script.run) {
          throw new Error('Google Apps Script environment is not ready.');
        }

        await google.script.run.withSuccessHandler(() => {
          hideLoading();
          hideEditModal();
          showModal('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à').then(() => {
            fetchRepairData(); // Refresh table
          });
          debugLog('Repair updated successfully for ID: ' + repairId);
        }).withFailureHandler(e => {
          hideLoading();
          showModal('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ' + e.message, '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
          debugLog('Failed to save edited repair: ' + e.message);
        }).updateRepair(repairId, updatedData); // Pass all updatedData to Code.gs
      } catch (error) {
        hideLoading();
        showModal('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
        debugLog('Error in saveEditedRepair: ' + error.message);
      }
    }

    /**
     * Marks a repair as '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'.
     */
    async function completeRepair() {
      const repairId = currentDetailRepairId; // Use the stored ID
      if (!repairId) {
          showModal('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å', '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
          return;
      }
      debugLog('completeRepair called for ID: ' + repairId);
      showModal('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô "‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£').then(async () => {
        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞...');
        try {
          if (typeof google === 'undefined' || !google.script || !google.script.run) throw new Error('Google Apps Script not ready.');
          await google.script.run.withSuccessHandler(() => {
            hideLoading();
            hideModal(); // Close detail modal
            showModal('‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏õ‡πá‡∏ô "‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"!', '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à').then(() => fetchRepairData());
            debugLog('Repair status set to "Completed" for ID: ' + repairId);
          }).withFailureHandler(e => {
            hideLoading(); showModal('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ: ' + e.message, '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'); debugLog('Failed to complete repair: ' + e.message);
          }).updateRepair(repairId, { '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞': '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' });
        } catch (error) { hideLoading(); showModal('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'); debugLog('Error in completeRepair: ' + error.message); }
      });
    }

    /**
     * Marks a repair as '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'.
     */
    async function cancelRepair() {
      const repairId = currentDetailRepairId; // Use the stored ID
      if (!repairId) {
          showModal('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å', '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
          return;
      }
      debugLog('cancelRepair called for ID: ' + repairId);
      showModal('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å" ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å').then(async () => {
        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞...');
        try {
          if (typeof google === 'undefined' || !google.script || !google.script.run) throw new Error('Google Apps Script not ready.');
          await google.script.run.withSuccessHandler(() => {
            hideLoading();
            hideModal(); // Close detail modal
            showModal('‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏ñ‡∏π‡∏Å "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å" ‡πÅ‡∏•‡πâ‡∏ß!', '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à').then(() => fetchRepairData());
            debugLog('Repair status set to "Cancelled" for ID: ' + repairId);
          }).withFailureHandler(e => {
            hideLoading(); showModal('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÑ‡∏î‡πâ: ' + e.message, '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'); debugLog('Failed to cancel repair: ' + e.message);
          }).updateRepair(repairId, { '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞': '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' });
        } catch (error) { hideLoading(); showModal('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'); debugLog('Error in cancelRepair: ' + error.message); }
      });
    }


    /**
     * Confirms deletion of a repair request and calls Apps Script to delete.
     * @param {string} repairId The ID of the repair to delete.
     */
    function confirmDelete(repairId) {
      debugLog('confirmDelete called for ID: ' + repairId);
      showModal('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏ô‡∏µ‡πâ? ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ', '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö').then(async () => {
        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
        try {
          if (typeof google === 'undefined' || !google.script || !google.script.run) {
            throw new Error('Google Apps Script environment is not ready.');
          }

          await google.script.run.withSuccessHandler(() => {
            hideLoading();
            hideModal();
            showModal('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à').then(() => {
              fetchRepairData(); // Refresh table after deletion
            });
            debugLog('Repair deleted successfully for ID: ' + repairId);
          }).withFailureHandler(e => {
            hideLoading();
            showModal('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö: ' + e.message, '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
            debugLog('Failed to delete repair: ' + e.message);
          }).deleteRepair(repairId); // Calls deleteRepair from Code.gs
        } catch (error) {
          hideLoading();
          showModal('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
          debugLog('Error in confirmDelete: ' + error.message);
        }
      });
    }

    // --- Page Initialization ---

    /**
     * Initializes the page by checking for Google Apps Script availability
     * and fetching data. Also handles URL query parameters for filtering.
     */
    document.addEventListener('DOMContentLoaded', function() {
      debugLog('Status page loaded, initializing...');
      
      let attempts = 0;
      const maxAttempts = 10;
      
      function checkGoogleScript() {
        attempts++;
        debugLog('Checking Google Apps Script availability, attempt: ' + attempts);
        
        if (typeof google !== 'undefined' && google.script && google.script.run) {
          debugLog('Google Apps Script is ready for status page.');
          
          // --- Read filter status from URL ---
          const urlParams = new URLSearchParams(window.location.search);
          const filterStatusFromUrl = urlParams.get('filterStatus');
          if (filterStatusFromUrl) {
            debugLog('Filter status found in URL: ' + filterStatusFromUrl);
            const statusSelect = document.getElementById('statusFilter');
            // Ensure the value exists in the dropdown before setting
            if (Array.from(statusSelect.options).some(option => option.value === filterStatusFromUrl)) {
                statusSelect.value = filterStatusFromUrl;
                currentFilterStatus = filterStatusFromUrl; // Set current filter
            } else {
                debugLog('Filter status from URL not found in dropdown options, defaulting to "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î".');
                statusSelect.value = '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
                currentFilterStatus = '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
            }
          } else {
            debugLog('No filter status found in URL, defaulting to "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î".');
            document.getElementById('statusFilter').value = '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
            currentFilterStatus = '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
          }

          // Fetch and display data
          fetchRepairData();

          // Add event listeners for filter/search
          document.getElementById('searchInput').addEventListener('keyup', applyFilter);
          document.getElementById('statusFilter').addEventListener('change', applyFilter);


        } else if (attempts < maxAttempts) {
          debugLog('Google Apps Script not ready yet, retrying in 500ms...');
          setTimeout(checkGoogleScript, 500);
        } else {
          debugLog('Google Apps Script failed to load after ' + maxAttempts + ' attempts for status page.');
          showModal('‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î Google Apps Script ‡πÑ‡∏î‡πâ<br><br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤:<br>1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï<br>2. ‡∏õ‡∏¥‡∏î Ad Blocker (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)<br>3. ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ');
        }
      }
      
      checkGoogleScript();
    });

    // Global error handler
    window.addEventListener('error', function(e) {
      debugLog('Global error on status page: ' + (e.error?.message || e.message));
      console.error('Global error on status page:', e);
    });
  </script>

</body>
</html>
