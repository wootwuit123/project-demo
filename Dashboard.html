<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Dashboard - ระบบแจ้งซ่อมไฟฟ้าสาธารณะ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js" crossorigin="anonymous"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Prompt', sans-serif;
      background: #f5f7fa;
      color: #2c3e50;
      display: flex;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Top Header Bar */
    .header-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 1.5rem;
      z-index: 1001;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
    }

    .header-left {
      display: flex;
      align-items: center;
      color: #fff;
    }

    .menu-toggle {
      background: none;
      border: none;
      color: #fff;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.5rem;
      margin-right: 1rem;
      border-radius: 6px;
      transition: all 0.2s ease;
    }

    .menu-toggle:hover {
      background: rgba(255,255,255,0.15);
      transform: translateY(-1px);
    }

    .header-title {
      font-size: 1.3rem;
      font-weight: 600;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .header-icon {
      margin-right: 0.8rem;
      font-size: 1.4rem;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
    }

    .header-right {
      display: flex;
      align-items: center;
    }

    /* User Menu in Header */
    .user-menu {
      position: relative;
      display: flex;
      align-items: center;
      gap: 0.7rem;
      margin-left: 1rem;
      padding: 0.4rem 1rem;
      border-radius: 25px;
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      transition: all 0.2s ease;
    }

    .user-menu:hover {
      background: rgba(255,255,255,0.15);
    }

    .user-menu img {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid rgba(255,255,255,0.3);
      transition: all 0.2s ease;
    }

    .user-menu:hover img {
      transform: scale(1.05);
      border-color: rgba(255,255,255,0.5);
    }

    .user-info-display {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      color: #e3f2fd;
      font-size: 0.9rem;
      line-height: 1.3;
    }

    .user-info-display .username {
      font-weight: 600;
      color: #fff;
      font-size: 1rem;
    }

    .user-info-display .position {
      font-size: 0.8rem;
      color: #bbdefb;
      opacity: 0.9;
    }

    .user-menu .dropdown {
      display: none;
      position: absolute;
      right: 0;
      top: 100%;
      margin-top: 8px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.15);
      overflow: hidden;
      min-width: 180px;
      z-index: 1002;
      border: 1px solid rgba(0,0,0,0.05);
    }

    .user-menu .dropdown a {
      display: flex;
      align-items: center;
      padding: 1rem 1.2rem;
      color: #2c3e50;
      text-decoration: none;
      font-size: 0.95rem;
      transition: all 0.2s ease;
      gap: 0.8rem;
    }

    .user-menu .dropdown a:hover {
      background: #f8f9fa;
      color: #1976D2;
      padding-left: 1.5rem;
    }

    .user-menu:hover .dropdown {
      display: block;
    }

    /* Professional Sidebar */
    .sidebar {
      position: fixed;
      top: 60px;
      left: -300px;
      width: 300px;
      height: calc(100vh - 60px);
      background: linear-gradient(180deg, #34495e 0%, #2c3e50 100%);
      transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1000;
      overflow-y: auto;
      border-right: 3px solid #3498db;
    }

    .sidebar.open {
      left: 0;
    }

    .sidebar-header {
      padding: 1.5rem;
      background: rgba(0,0,0,0.1);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      text-align: center;
    }

    .sidebar-header .logo {
      font-size: 1.8rem;
      color: #3498db;
      margin-bottom: 0.5rem;
    }

    .sidebar-header .title {
      color: #ecf0f1;
      font-size: 1rem;
      font-weight: 500;
    }

    .sidebar-nav {
      padding: 1rem 0;
    }

    .nav-section {
      margin-bottom: 1.5rem;
    }

    .nav-section-title {
      padding: 0.8rem 1.5rem 0.5rem;
      color: #95a5a6;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 0.5rem;
    }

    .sidebar-nav a {
      display: flex;
      align-items: center;
      padding: 1rem 1.5rem;
      color: #bdc3c7;
      text-decoration: none;
      transition: all 0.3s ease;
      border-left: 4px solid transparent;
      font-weight: 500;
      position: relative;
    }

    .sidebar-nav a:hover {
      background: rgba(52, 152, 219, 0.15);
      border-left-color: #3498db;
      color: #ecf0f1;
      padding-left: 2rem;
      transform: translateX(5px);
    }

    .sidebar-nav a.active {
      background: linear-gradient(90deg, rgba(231, 76, 60, 0.2) 0%, rgba(231, 76, 60, 0.05) 100%);
      border-left-color: #e74c3c;
      color: #fff;
      font-weight: 600;
    }

    .sidebar-nav a.active::after {
      content: '';
      position: absolute;
      right: 1rem;
      width: 8px;
      height: 8px;
      background: #e74c3c;
      border-radius: 50%;
      box-shadow: 0 0 10px rgba(231, 76, 60, 0.5);
    }

    .sidebar-nav a i {
      width: 24px;
      margin-right: 1rem;
      font-size: 1.2rem;
      text-align: center;
    }

    .sidebar-nav a span {
      flex-grow: 1;
    }

    /* Overlay */
    .sidebar-overlay {
      position: fixed;
      top: 60px;
      left: 0;
      width: 100%;
      height: calc(100vh - 60px);
      background: rgba(0,0,0,0.5);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      z-index: 999;
      backdrop-filter: blur(2px);
    }

    .sidebar-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    /* Main Content */
    .main-wrapper {
      flex: 1;
      margin-top: 60px;
      transition: margin-left 0.3s ease;
    }

    .main {
      padding: 2rem;
      min-height: calc(100vh - 60px);
    }

    .page-header {
      text-align: center;
      margin-bottom: 3rem;
      padding-bottom: 2rem;
      border-bottom: 2px solid #f1f3f4;
    }

    .page-header h2 {
      font-size: 2.8rem;
      font-weight: 700;
      color: #1976D2;
      margin-bottom: 1rem;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
    }

    .page-header p {
      font-size: 1.2rem;
      color: #546e7a;
      line-height: 1.6;
      max-width: 600px;
      margin: 0 auto;
    }

    /* Professional Dashboard Cards */
    .dashboard-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 3rem;
    }

    .card {
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.08);
      padding: 2rem;
      text-align: center;
      transition: all 0.3s ease;
      border: 1px solid rgba(0,0,0,0.05);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--card-color), var(--card-color-light));
    }

    .card:hover {
      transform: translateY(-8px);
      box-shadow: 0 16px 48px rgba(0,0,0,0.15);
    }

    .card .icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      color: var(--card-color);
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    }

    .card .title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #546e7a;
      margin-bottom: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .card .value {
      font-size: 3rem;
      font-weight: 700;
      color: var(--card-color);
      line-height: 1;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .card.total {
      --card-color: #1976D2;
      --card-color-light: #42a5f5;
    }

    .card.reported {
      --card-color: #FF9800;
      --card-color-light: #ffb74d;
    }

    .card.inProgress {
      --card-color: #2196F3;
      --card-color-light: #64b5f6;
    }

    .card.completed {
      --card-color: #4CAF50;
      --card-color-light: #81c784;
    }

    .card.cancelled {
      --card-color: #F44336;
      --card-color-light: #e57373;
    }

    /* Professional Chart Section */
    .chart-section {
      background: #ffffff;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.08);
      padding: 2.5rem;
      border: 1px solid rgba(0,0,0,0.05);
      margin-bottom: 2rem;
    }

    .chart-section h3 {
      font-size: 1.8rem;
      font-weight: 600;
      color: #1976D2;
      margin-bottom: 2rem;
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }

    .chart-placeholder {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      height: 300px;
      border-radius: 15px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: #6c757d;
      font-size: 1.2rem;
      font-weight: 500;
      border: 2px dashed #dee2e6;
      position: relative;
      overflow: hidden;
    }

    .chart-placeholder::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: repeating-linear-gradient(
        45deg,
        transparent,
        transparent 10px,
        rgba(25, 118, 210, 0.05) 10px,
        rgba(25, 118, 210, 0.05) 20px
      );
      animation: chartPattern 20s linear infinite;
    }

    @keyframes chartPattern {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }

    .chart-placeholder .chart-icon {
      font-size: 4rem;
      color: #1976D2;
      margin-bottom: 1rem;
      opacity: 0.6;
    }

    /* Welcome Message */
    .welcome-section {
      background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
      border-radius: 20px;
      padding: 2.5rem;
      margin-bottom: 3rem;
      text-align: center;
      border: 1px solid rgba(25, 118, 210, 0.1);
    }

    .welcome-section h3 {
      font-size: 1.8rem;
      color: #1976D2;
      margin-bottom: 1rem;
      font-weight: 600;
    }

    .welcome-section p {
      font-size: 1.1rem;
      color: #546e7a;
      line-height: 1.6;
    }

    /* Loading และ Modal styles */
    .loading-overlay, .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1003;
      backdrop-filter: blur(3px);
    }

    .loading-content, .modal-content {
      background: #fff;
      border-radius: 20px;
      padding: 3rem;
      text-align: center;
      max-width: 500px;
      border: 1px solid rgba(0,0,0,0.1);
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .loading-spinner {
      border: 4px solid rgba(25, 118, 210, 0.2);
      border-top: 4px solid #1976D2;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-message {
      font-size: 1.2rem;
      color: #546e7a;
      font-weight: 500;
    }

    .modal-content h3 {
      font-size: 2rem;
      margin-bottom: 1.5rem;
      color: #1976D2;
      font-weight: 700;
    }

    .modal-content p {
      font-size: 1.1rem;
      color: #555;
      margin-bottom: 2rem;
      line-height: 1.6;
    }

    .modal-close-button {
      background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
      color: white;
      border: none;
      padding: 1rem 2.5rem;
      border-radius: 12px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(25, 118, 210, 0.3);
    }

    .modal-close-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(25, 118, 210, 0.4);
    }

    /* Quick Actions */
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 3rem;
    }

    .quick-action-btn {
      background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
      color: white;
      border: none;
      padding: 1.5rem;
      border-radius: 15px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.8rem;
      text-decoration: none;
      box-shadow: 0 4px 15px rgba(25, 118, 210, 0.3);
    }

    .quick-action-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(25, 118, 210, 0.4);
    }

    .quick-action-btn.secondary {
      background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    }

    .quick-action-btn.secondary:hover {
      box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .header-bar {
        padding: 0 1rem;
      }

      .header-title {
        font-size: 1rem;
      }

      .user-info-display {
        display: none;
      }

      .sidebar {
        width: 100%;
        left: -100%;
      }

      .main {
        padding: 1rem;
      }

      .page-header h2 {
        font-size: 2rem;
        flex-direction: column;
        gap: 0.5rem;
      }

      .dashboard-cards {
        grid-template-columns: 1fr;
      }

      .quick-actions {
        grid-template-columns: 1fr;
      }

      .chart-section {
        padding: 1.5rem;
      }

      .welcome-section {
        padding: 1.5rem;
      }
    }

    @media (min-width: 1200px) {
      .main-wrapper.sidebar-open {
        margin-left: 300px;
      }
    }

    /* Animation Classes */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .main {
      animation: fadeIn 0.6s ease-out;
    }

    @keyframes slideIn {
      from { transform: translateX(-100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .sidebar.open {
      animation: slideIn 0.3s ease-out;
    }

    @keyframes countUp {
      from { opacity: 0; transform: scale(0.5); }
      to { opacity: 1; transform: scale(1); }
    }

    .card .value {
      animation: countUp 0.6s ease-out;
      animation-delay: 0.2s;
      animation-fill-mode: both;
    }
  </style>
</head>
<body>

  <!-- Header Bar -->
  <header class="header-bar">
    <div class="header-left">
      <button class="menu-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
      </button>
      <i class="fas fa-bolt header-icon"></i>
      <div class="header-title">ระบบแจ้งซ่อมไฟฟ้าสาธารณะ</div>
    </div>
    <div class="header-right">
      <div class="user-menu">
        <img src="https://placehold.co/36x36/1976D2/FFFFFF?text=👤" alt="User">
        <div class="user-info-display">
          <span class="username" id="loggedInUsername">ผู้ดูแลระบบ</span>
          <div class="position" id="loggedInUserPosition">เจ้าหน้าที่</div>
        </div>
        <div class="dropdown">
          <a href="#"><i class="fas fa-user-cog"></i> โปรไฟล์</a>
          <a href="#"><i class="fas fa-cog"></i> ตั้งค่า</a>
          <a onclick="logout()"><i class="fas fa-sign-out-alt"></i> ออกจากระบบ</a>
        </div>
      </div>
    </div>
  </header>

  <!-- Professional Sidebar -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="logo">
        <i class="fas fa-tools"></i>
      </div>
      <div class="title">ระบบจัดการแจ้งซ่อม</div>
    </div>
    <div class="sidebar-nav">
      <div class="nav-section">
        <div class="nav-section-title">เมนูหลัก</div>
        <a onclick="loadDashboard()" class="active">
          <i class="fas fa-tachometer-alt"></i>
          <span>หน้าหลัก</span>
        </a>
        <a onclick="loadReportRepair()">
          <i class="fas fa-plus-circle"></i>
          <span>แจ้งซ่อมใหม่</span>
        </a>
        <a onclick="loadStatus()">
          <i class="fas fa-clipboard-list"></i>
          <span>จัดการแจ้งซ่อม</span>
        </a>
      </div>
      
      <div class="nav-section">
        <div class="nav-section-title">รายงาน</div>
        <a href="#">
          <i class="fas fa-chart-bar"></i>
          <span>รายงาน</span>
        </a>
        <a href="#">
          <i class="fas fa-chart-pie"></i>
          <span>สถิติ</span>
        </a>
      </div>
      
      <div class="nav-section">
        <div class="nav-section-title">จัดการระบบ</div>
        <a href="#">
          <i class="fas fa-users"></i>
          <span>จัดการผู้ใช้</span>
        </a>
        <a href="#">
          <i class="fas fa-cogs"></i>
          <span>ตั้งค่าระบบ</span>
        </a>
      </div>
    </div>
  </nav>

  <!-- Sidebar Overlay -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

  <!-- Main Content Wrapper -->
  <div class="main-wrapper" id="mainWrapper">
    <div class="main">
      <div class="page-header">
        <h2>
          <i class="fas fa-tachometer-alt"></i>
          ภาพรวมระบบ
        </h2>
        <p>ติดตามสถานะการแจ้งซ่อมและดูข้อมูลสรุปทั้งหมดในระบบ</p>
      </div>

      <!-- Quick Actions -->
      <div class="quick-actions">
        <button class="quick-action-btn" onclick="loadReportRepair()">
          <i class="fas fa-plus-circle"></i>
          แจ้งซ่อมใหม่
        </button>
        <button class="quick-action-btn secondary" onclick="loadStatus()">
          <i class="fas fa-list"></i>
          ดูรายการทั้งหมด
        </button>
      </div>

      <!-- Dashboard Cards -->
      <div class="dashboard-cards" id="dashboard-cards">
        <div class="card total">
          <div class="icon"><i class="fas fa-clipboard-list"></i></div>
          <div class="title">แจ้งซ่อมทั้งหมด</div>
          <div class="value" id="total-repairs">0</div>
        </div>
        <div class="card reported">
          <div class="icon"><i class="fas fa-clock"></i></div>
          <div class="title">แจ้งซ่อมแล้ว</div>
          <div class="value" id="reported-repairs">0</div>
        </div>
        <div class="card inProgress">
          <div class="icon"><i class="fas fa-cogs"></i></div>
          <div class="title">กำลังดำเนินการ</div>
          <div class="value" id="inProgress-repairs">0</div>
        </div>
        <div class="card completed">
          <div class="icon"><i class="fas fa-check-circle"></i></div>
          <div class="title">เสร็จเรียบร้อย</div>
          <div class="value" id="completed-repairs">0</div>
        </div>
        <div class="card cancelled">
          <div class="icon"><i class="fas fa-times-circle"></i></div>
          <div class="title">ยกเลิก</div>
          <div class="value" id="cancelled-repairs">0</div>
        </div>
      </div>

      <!-- Welcome Section -->
      <div class="welcome-section" id="welcome-section" style="display: none;">
        <h3>ยินดีต้อนรับสู่ระบบแจ้งซ่อมไฟฟ้าสาธารณะ</h3>
        <p>ยังไม่มีข้อมูลการแจ้งซ่อมในระบบ เริ่มต้นใช้งานโดยการคลิก "แจ้งซ่อมใหม่" เพื่อรายงานปัญหาที่พบ</p>
      </div>

      <!-- Chart Section -->
      <div class="chart-section">
        <h3>
          <i class="fas fa-chart-area"></i>
          สถิติการแจ้งซ่อม
        </h3>
        <div class="chart-placeholder">
          <div class="chart-icon">
            <i class="fas fa-chart-bar"></i>
          </div>
          <div>กราฟแสดงสถิติจะปรากฏที่นี่</div>
          <small style="margin-top: 0.5rem; opacity: 0.7;">(อาจใช้ Chart.js ในอนาคต)</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay" style="display: none;">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <p id="loading-message" class="loading-message">กำลังโหลดข้อมูล...</p>
    </div>
  </div>

  <!-- Custom Modal -->
  <div id="custom-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <h3 id="modal-title">แจ้งเตือน</h3>
      <p id="modal-message"></p>
      <button class="modal-close-button" onclick="hideModal()">ตกลง</button>
    </div>
  </div>

  <script>
    // Sidebar functions
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      const mainWrapper = document.getElementById('mainWrapper');
      
      if (sidebar.classList.contains('open')) {
        closeSidebar();
      } else {
        openSidebar();
      }
    }

    function openSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      const mainWrapper = document.getElementById('mainWrapper');
      
      sidebar.classList.add('open');
      overlay.classList.add('show');
      
      if (window.innerWidth >= 1200) {
        mainWrapper.classList.add('sidebar-open');
      }
    }

    function closeSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      const mainWrapper = document.getElementById('mainWrapper');
      
      sidebar.classList.remove('open');
      overlay.classList.remove('show');
      mainWrapper.classList.remove('sidebar-open');
    }

    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', function(event) {
      const sidebar = document.getElementById('sidebar');
      const menuToggle = document.querySelector('.menu-toggle');
      
      if (sidebar.classList.contains('open') && 
          !sidebar.contains(event.target) && 
          !menuToggle.contains(event.target)) {
        closeSidebar();
      }
    });

    // Close sidebar on window resize if needed
    window.addEventListener('resize', function() {
      if (window.innerWidth >= 1200) {
        const sidebar = document.getElementById('sidebar');
        const mainWrapper = document.getElementById('mainWrapper');
        if (sidebar.classList.contains('open')) {
          mainWrapper.classList.add('sidebar-open');
        }
      } else {
        const mainWrapper = document.getElementById('mainWrapper');
        mainWrapper.classList.remove('sidebar-open');
      }
    });

    // Debug function
    function debugLog(message) {
      console.log('🔧 DASHBOARD DEBUG:', message);
    }

    // Modal functions
    function showModal(message, title = 'แจ้งเตือน') {
      return new Promise(resolve => {
        const modal = document.getElementById('custom-modal');
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-message').innerHTML = message;
        modal.style.display = 'flex';
        document.querySelector('.modal-close-button').onclick = () => {
          hideModal();
          resolve();
        };
      });
    }

    function hideModal() {
      document.getElementById('custom-modal').style.display = 'none';
    }

    function showLoading(message = 'กำลังโหลดข้อมูล...') {
      document.getElementById('loading-message').textContent = message;
      document.getElementById('loading-overlay').style.display = 'flex';
    }

    function hideLoading() {
      document.getElementById('loading-overlay').style.display = 'none';
    }

    // Navigation functions
    function loadDashboard() {
      debugLog('loadDashboard called');
      closeSidebar();
      location.reload();
    }

    function loadReportRepair() {
      debugLog('loadReportRepair called');
      closeSidebar();
      
      try {
        if (typeof google === 'undefined' || !google.script || !google.script.run) {
          throw new Error('Google Apps Script ไม่พร้อมใช้งาน');
        }
        
        showLoading('กำลังโหลดหน้าแจ้งซ่อม...');
        
        google.script.run
          .withSuccessHandler(html => { 
            debugLog('Report repair page loaded successfully');
            hideLoading();
            document.open(); 
            document.write(html); 
            document.close(); 
          })
          .withFailureHandler(e => { 
            debugLog('Report repair page error: ' + e.message);
            hideLoading();
            showModal('เกิดข้อผิดพลาด: ' + e.message, 'ไม่สามารถโหลดหน้าแจ้งซ่อมได้').then(() => {
              google.script.run.withSuccessHandler(html => { 
                document.open(); 
                document.write(html); 
                document.close(); 
              }).getLoginPage(); 
            });
          })
          .getReportRepairPage();
          
      } catch (error) {
        debugLog('Navigation error: ' + error.message);
        hideLoading();
        showModal('เกิดข้อผิดพลาด: ' + error.message + '<br><br>กรุณาลองรีเฟรชหน้าเว็บ', 'ข้อผิดพลาด');
      }
    }

    function loadStatus() {
      debugLog('loadStatus called');
      closeSidebar();
      
      try {
        if (typeof google === 'undefined' || !google.script || !google.script.run) {
          throw new Error('Google Apps Script ไม่พร้อมใช้งาน');
        }
        
        showLoading('กำลังโหลดหน้าจัดการแจ้งซ่อม...');
        
        google.script.run
          .withSuccessHandler(html => { 
            debugLog('Status page loaded successfully');
            hideLoading();
            document.open(); 
            document.write(html); 
            document.close(); 
          })
          .withFailureHandler(e => { 
            debugLog('Status page error: ' + e.message);
            hideLoading();
            showModal('เกิดข้อผิดพลาด: ' + e.message, 'ไม่สามารถโหลดหน้าจัดการได้').then(() => {
              google.script.run.withSuccessHandler(html => { 
                document.open(); 
                document.write(html); 
                document.close(); 
              }).getLoginPage(); 
            });
          })
          .getStatusPage();
          
      } catch (error) {
        debugLog('Navigation error: ' + error.message);
        hideLoading();
        showModal('เกิดข้อผิดพลาด: ' + error.message + '<br><br>กรุณาลองรีเฟรชหน้าเว็บ', 'ข้อผิดพลาด');
      }
    }

    function logout() {
      debugLog('logout called');
      closeSidebar();
      
      showModal('คุณต้องการออกจากระบบหรือไม่?', 'ยืนยันการออกจากระบบ').then(() => {
        try {
          if (typeof google === 'undefined' || !google.script || !google.script.run) {
            throw new Error('Google Apps Script ไม่พร้อมใช้งาน');
          }
          
          showLoading('กำลังออกจากระบบ...');
          
          google.script.run
            .withSuccessHandler(html => { 
              debugLog('Logout successful');
              hideLoading();
              document.open(); 
              document.write(html); 
              document.close(); 
            })
            .withFailureHandler(e => { 
              debugLog('Logout error: ' + e.message);
              hideLoading();
              showModal('เกิดข้อผิดพลาดในการออกจากระบบ: ' + e.message, 'ข้อผิดพลาด');
            })
            .doLogout();
            
        } catch (error) {
          debugLog('Logout navigation error: ' + error.message);
          hideLoading();
          showModal('เกิดข้อผิดพลาด: ' + error.message, 'ข้อผิดพลาด');
        }
      });
    }

    // Dashboard data loading
    function loadDashboardSummary() {
      debugLog('loadDashboardSummary called');
      
      try {
        if (typeof google === 'undefined' || !google.script || !google.script.run) {
          debugLog('Google Apps Script not available');
          showModal('ระบบไม่สามารถเชื่อมต่อได้<br><br>กรุณา:<br>1. ตรวจสอบการเชื่อมต่ออินเทอร์เน็ต<br>2. รีเฟรชหน้าเว็บ<br>3. ลองเข้าใหม่อีกครั้ง', 'ไม่สามารถเชื่อมต่อได้');
          return;
        }
        
        showLoading('กำลังโหลดข้อมูลสรุป...');
        
        google.script.run
          .withSuccessHandler(data => {
            debugLog('Dashboard data loaded: ' + JSON.stringify(data));
            hideLoading();
            
            // Update dashboard cards with animation
            updateDashboardCard('total-repairs', data.total || 0);
            updateDashboardCard('reported-repairs', data.reported || 0);
            updateDashboardCard('inProgress-repairs', data.inProgress || 0);
            updateDashboardCard('completed-repairs', data.completed || 0);
            updateDashboardCard('cancelled-repairs', data.cancelled || 0);
            
            // Show welcome message if no data
            if (data.total === 0) {
              document.getElementById('welcome-section').style.display = 'block';
              setTimeout(() => {
                showModal('ยินดีต้อนรับสู่ระบบแจ้งซ่อมไฟฟ้าสาธารณะ!<br><br>เริ่มต้นใช้งานโดยการคลิก "แจ้งซ่อมใหม่" เพื่อรายงานปัญหาที่พบ', 'ยินดีต้อนรับ');
              }, 1000);
            } else {
              document.getElementById('welcome-section').style.display = 'none';
            }
          })
          .withFailureHandler(e => {
            debugLog('Dashboard data error: ' + e.message);
            hideLoading();
            console.error('Dashboard summary error:', e);
            showModal('เกิดข้อผิดพลาดในการดึงข้อมูลสรุป<br><br>อาจเป็นเพราะ:<br>1. Session หมดอายุ<br>2. ไม่มีสิทธิ์เข้าถึง<br><br>กำลังพาไปหน้าเข้าสู่ระบบ...', 'ข้อผิดพลาด').then(() => {
              google.script.run.withSuccessHandler(html => {
                document.open(); 
                document.write(html); 
                document.close();
              }).getLoginPage();
            });
          })
          .getDashboardSummary();
          
      } catch (error) {
        debugLog('Dashboard summary initialization error: ' + error.message);
        hideLoading();
        showModal('เกิดข้อผิดพลาดในการเริ่มต้นระบบ: ' + error.message, 'ข้อผิดพลาด');
      }
    }

    // Animated counter for dashboard cards
    function updateDashboardCard(elementId, targetValue) {
      const element = document.getElementById(elementId);
      const duration = 1000; // 1 second
      const frameDuration = 1000 / 60; // 60 FPS
      const totalFrames = Math.round(duration / frameDuration);
      const easeOutQuad = t => t * (2 - t);
      
      let frame = 0;
      const counter = setInterval(() => {
        frame++;
        const progress = easeOutQuad(frame / totalFrames);
        const currentValue = Math.round(targetValue * progress);
        
        element.textContent = currentValue.toLocaleString();
        
        if (frame === totalFrames) {
          clearInterval(counter);
          element.textContent = targetValue.toLocaleString();
        }
      }, frameDuration);
    }

    /**
     * Fetches the logged-in user's details and displays them.
     */
    function fetchAndDisplayUserDetails() {
      debugLog('fetchAndDisplayUserDetails called');
      try {
        if (typeof google === 'undefined' || !google.script || !google.script.run) {
          debugLog('Google Apps Script not ready, cannot fetch user details.');
          return;
        }

        google.script.run
          .withSuccessHandler(userDetails => {
            if (userDetails) {
              document.getElementById('loggedInUsername').textContent = userDetails.username || 'ผู้ใช้งาน';
              document.getElementById('loggedInUserPosition').textContent = userDetails.position || 'ไม่ระบุตำแหน่ง';
              debugLog('User details displayed: ' + JSON.stringify(userDetails));
            } else {
              document.getElementById('loggedInUsername').textContent = 'ไม่ได้เข้าสู่ระบบ';
              document.getElementById('loggedInUserPosition').textContent = '';
              debugLog('No user logged in or details not found.');
            }
          })
          .withFailureHandler(e => {
            console.error('Failed to fetch user details:', e.message);
            document.getElementById('loggedInUsername').textContent = 'เกิดข้อผิดพลาด';
            document.getElementById('loggedInUserPosition').textContent = '';
          })
          .getLoggedInUserDetails();
      } catch (error) {
        console.error('Error in fetchAndDisplayUserDetails:', error.message);
      }
    }

    // Auto-load dashboard data and user details when page loads
    document.addEventListener('DOMContentLoaded', function() {
      debugLog('Dashboard page loaded, initializing...');
      
      let attempts = 0;
      const maxAttempts = 10;
      
      function checkGoogleScript() {
        attempts++;
        debugLog('Checking Google Apps Script availability, attempt: ' + attempts);
        
        if (typeof google !== 'undefined' && google.script && google.script.run) {
          debugLog('Google Apps Script is ready');
          setTimeout(loadDashboardSummary, 800);
          fetchAndDisplayUserDetails();
        } else if (attempts < maxAttempts) {
          debugLog('Google Apps Script not ready yet, retrying...');
          setTimeout(checkGoogleScript, 500);
        } else {
          debugLog('Google Apps Script failed to load after ' + maxAttempts + ' attempts');
          showModal('ระบบไม่สามารถโหลด Google Apps Script ได้<br><br>กรุณา:<br>1. ตรวจสอบการเชื่อมต่ออินเทอร์เน็ต<br>2. ปิด Ad Blocker (ถ้ามี)<br>3. รีเฟรชหน้าเว็บ', 'ไม่สามารถโหลดระบบได้');
        }
      }
      
      checkGoogleScript();
    });

    // Global error handler
    window.addEventListener('error', function(e) {
      debugLog('Global error: ' + (e.error?.message || e.message));
      console.error('Global error:', e);
    });
  </script>

</body>
</html>
